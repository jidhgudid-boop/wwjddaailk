# 文件传输策略配置示例
# 简化版：只需配置一个参数！

# ============================================================================
# 快速配置：只需修改一个值
# ============================================================================

# 流式传输阈值：>= 此值使用 StreamingResponse，< 此值使用 FileResponse
STREAMING_THRESHOLD = 1 * 1024 * 1024  # 1MB（默认推荐）


# ============================================================================
# 常见场景配置
# ============================================================================

# 场景 1: 标准配置（默认推荐）
# ============================================================================
STREAMING_THRESHOLD = 1 * 1024 * 1024  # 1MB

# 适用于：大部分场景，硬盘性能正常的服务器
# 效果：< 1MB 的小文件用 sendfile（零拷贝），>= 1MB 的文件用流式传输


# 场景 2: 硬盘 IO 性能差的 VPS（廉价 VPS）
# ============================================================================
# STREAMING_THRESHOLD = 100 * 1024  # 100KB
# 或者
# STREAMING_THRESHOLD = 500 * 1024  # 500KB

# 适用于：
# - 硬盘读取速度 < 50MB/s
# - iostat 显示 wa% > 20%
# - 下载时感觉卡顿，等待时间长
#
# 效果：
# - 更多文件使用流式传输（边读边传）
# - 首字节时间更短（用户立即看到下载开始）
# - 减少硬盘单次大量读取压力


# 场景 3: 高性能服务器（SSD，内存充足）
# ============================================================================
# STREAMING_THRESHOLD = 5 * 1024 * 1024   # 5MB
# 或者
# STREAMING_THRESHOLD = 10 * 1024 * 1024  # 10MB

# 适用于：
# - SSD 服务器
# - 硬盘读取 > 200MB/s
# - 内存充足（> 16GB）
#
# 效果：
# - 更多文件使用 FileResponse (sendfile)
# - 零拷贝传输，性能最优
# - CPU 占用更低


# 场景 4: HLS 视频流
# ============================================================================
# STREAMING_THRESHOLD = 1 * 1024 * 1024  # 1MB
# 或者
# STREAMING_THRESHOLD = 2 * 1024 * 1024  # 2MB

# 说明：
# - HLS 切片（.ts 文件）通常 2-5MB
# - 使用流式传输确保显示下载进度
# - m3u8 文件很小（几KB），自动使用 FileResponse


# 场景 5: 极度节省内存/全部流式传输
# ============================================================================
# STREAMING_THRESHOLD = 0  # 所有文件都用流式传输

# 适用于：
# - 极低内存的环境
# - 想要所有文件都显示进度
#
# 注意：性能会略有下降（所有文件都分块读取）


# ============================================================================
# 使用方法
# ============================================================================
#
# 1. 选择上面的一个配置场景
# 2. 复制对应的 STREAMING_THRESHOLD 行
# 3. 粘贴到 models/config.py 文件的 Config 类中
# 4. 重启服务器：./run.sh
# 5. 验证配置：
#    python -c "from models.config import config; print(f'STREAMING_THRESHOLD: {config.STREAMING_THRESHOLD/(1024*1024):.2f}MB')"


# ============================================================================
# 如何判断您需要哪种配置？
# ============================================================================
#
# 测试硬盘读取速度：
# dd if=/data/large_file.mp4 of=/dev/null bs=1M count=100
#
# 结果：
# - 速度 > 100MB/s：使用场景 3（5-10MB）
# - 速度 50-100MB/s：使用场景 1（1MB，默认）✅
# - 速度 < 50MB/s：使用场景 2（100-500KB）✅
#
# 查看 IO 等待：
# iostat -x 1
#
# 结果：
# - wa% < 10%：IO 正常，使用场景 1 或 3
# - wa% 10-20%：IO 压力中等，使用场景 1（默认）
# - wa% > 20%：IO 压力大，使用场景 2（100-500KB）✅


# ============================================================================
# 配置说明
# ============================================================================
#
# 简化后的配置：
# - 只有一个参数：STREAMING_THRESHOLD
# - 简单清晰：>= 阈值用流式，< 阈值用 sendfile
# - 易于理解和调整
#
# 传输策略：
# - 文件 < STREAMING_THRESHOLD：
#   使用 FileResponse + sendfile（零拷贝，性能最优）
#
# - 文件 >= STREAMING_THRESHOLD：
#   使用 StreamingResponse（流式传输，显示进度，支持 Range）
#
# - Range 请求（断点续传）：
#   自动使用 StreamingResponse（不受阈值限制）


# ============================================================================
# 常见问题
# ============================================================================
#
# Q: 只有一个阈值够用吗？
# A: 够用！简化后的配置已经能满足 99% 的场景。
#
# Q: 我应该设置多大？
# A: 从 1MB 开始，根据实际情况调整：
#    - 硬盘慢 → 降到 100-500KB
#    - 硬盘快 → 升到 5-10MB
#    - 不确定 → 保持 1MB
#
# Q: StreamingResponse 会影响速度吗？
# A: 不会。只是改变传输方式，不影响实际下载速度。
#
# Q: 修改后需要重启吗？
# A: 是的，需要重启：./run.sh


# ============================================================================
# 推荐配置
# ============================================================================
#
# 大部分用户：
STREAMING_THRESHOLD = 1 * 1024 * 1024  # 1MB（默认）
#
# 廉价 VPS（硬盘慢）：
# STREAMING_THRESHOLD = 500 * 1024  # 500KB
#
# 高性能服务器：
# STREAMING_THRESHOLD = 5 * 1024 * 1024  # 5MB
