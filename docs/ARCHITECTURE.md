# 架构图

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Client (Browser/Player)                 │
└────────────────────────┬────────────────────────────────────┘
                         │ HTTP/2
                         │
┌────────────────────────▼────────────────────────────────────┐
│                    FastAPI Application                       │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Middleware Layer                        │   │
│  │  ┌─────────┐  ┌─────────┐  ┌──────────┐            │   │
│  │  │  CORS   │  │  GZip   │  │  Auth    │ (待添加)  │   │
│  │  └─────────┘  └─────────┘  └──────────┘            │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Routes Layer                            │   │
│  │  ┌─────────┐  ┌──────────┐  ┌─────────┐            │   │
│  │  │ Proxy   │  │ Monitor  │  │  API    │            │   │
│  │  └─────────┘  └──────────┘  └─────────┘            │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Services Layer                          │   │
│  │  ┌───────────────┐  ┌───────────────┐               │   │
│  │  │ StreamProxy   │  │ HTTPClient    │               │   │
│  │  │   Service     │  │   Service     │               │   │
│  │  │  (HLS优化)    │  │  (HTTP/2)     │               │   │
│  │  └───────┬───────┘  └───────┬───────┘               │   │
│  │          │                  │                        │   │
│  │  ┌───────▼──────────────────▼───────┐               │   │
│  │  │     Redis Service                │               │   │
│  │  │   (连接池 + Pipeline)            │               │   │
│  │  └──────────────────────────────────┘               │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Utils Layer                             │   │
│  │  ┌────────────┐  ┌─────────────┐  ┌──────────────┐ │   │
│  │  │   CIDR     │  │   Browser   │  │   Helpers    │ │   │
│  │  │  Matcher   │  │  Detector   │  │              │ │   │
│  │  └────────────┘  └─────────────┘  └──────────────┘ │   │
│  └──────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
┌───────▼──────┐  ┌──────▼──────┐  ┌────▼────────┐
│    Redis     │  │   Backend   │  │   Traffic   │
│   Database   │  │   Server    │  │  Collector  │
└──────────────┘  └─────────────┘  └─────────────┘
```

## 数据流

### HLS 流式传输流程

```
Client Request (m3u8/ts)
    │
    ▼
┌─────────────────────────┐
│  FastAPI Route Handler  │
│  - 验证 HMAC             │
│  - 检查会话              │
│  - IP 白名单验证         │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  StreamProxy Service    │
│  - HTTP/2 请求           │
│  - 零拷贝流式传输        │
│  - 背压控制              │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  HTTPClient Service     │
│  - 连接池管理            │
│  - Keep-alive 优化       │
│  - 自动重试              │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│    Backend Server       │
│  (Origin Server)        │
└───────────┬─────────────┘
            │
            ▼
   Streaming Response
   (Chunks: 8192 bytes)
            │
            ▼
        Client
```

## 性能优化点

### 1. 连接层优化
```
HTTP/2 多路复用
    ↓
连接池 (100 connections)
    ↓
Keep-Alive (30 connections/host)
    ↓
智能连接复用
```

### 2. 传输层优化
```
零拷贝传输
    ↓
Chunk流式传输 (8KB)
    ↓
背压控制
    ↓
异步非阻塞
```

### 3. 事件循环优化
```
uvloop (高性能)
    ↓
完全异步架构
    ↓
并发请求处理
    ↓
资源高效利用
```

## 监控架构

```
┌──────────────────────────────────────┐
│       Web Monitoring Dashboard        │
│  ┌────────────────────────────────┐  │
│  │     Real-time Metrics          │  │
│  │  - System Health               │  │
│  │  - Redis Performance           │  │
│  │  - Active Connections          │  │
│  │  - Traffic Statistics          │  │
│  └────────────┬───────────────────┘  │
└───────────────┼──────────────────────┘
                │
     ┌──────────┴──────────┐
     │                     │
┌────▼────┐          ┌─────▼─────┐
│ /health │          │  /stats   │
│endpoint │          │ endpoint  │
└─────────┘          └───────────┘
```

## 安全架构

```
Request
    │
    ▼
┌─────────────────┐
│  CORS Check     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  HMAC Verify    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  IP Whitelist   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Session Check   │
└────────┬────────┘
         │
         ▼
    Proxy Pass
```

## 扩展性

### 水平扩展
```
Load Balancer
    │
    ├─── Worker 1 (FastAPI + Uvicorn)
    │
    ├─── Worker 2 (FastAPI + Uvicorn)
    │
    ├─── Worker 3 (FastAPI + Uvicorn)
    │
    └─── Worker N ...
          │
          └─── Shared Redis
```

### 高可用
```
┌────────────┐      ┌────────────┐
│  Primary   │◄────►│  Standby   │
│   Redis    │      │   Redis    │
└────────────┘      └────────────┘
      │
      │ Replication
      ▼
┌────────────┐
│  Backend   │
│  Cluster   │
└────────────┘
```
