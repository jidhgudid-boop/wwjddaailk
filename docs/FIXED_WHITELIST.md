# 固定白名单 IP 功能使用说明

## 概述

固定白名单 IP 功能允许在 `config.py` 中配置一组 IP 地址或 CIDR 范围，这些 IP 将完全跳过所有安全验证，直接放行。这对于内部服务、管理工具或可信任的客户端非常有用。

## 功能特点

- **完全跳过验证**：白名单中的 IP 将跳过所有安全检查，包括：
  - IP 白名单检查
  - 路径保护检查
  - 会话验证
  - HMAC 签名验证

- **灵活的 IP 格式支持**：
  - 单个 IP 地址：`192.168.1.100`
  - CIDR 范围：`192.168.1.0/24`、`10.0.0.0/8`
  - 混合配置：可以同时配置单个 IP 和 CIDR 范围

- **性能优化**：白名单检查在验证流程的最早阶段执行，避免不必要的 Redis 查询和数据库访问

## 配置方法

在 `models/config.py` 中找到 `FIXED_IP_WHITELIST` 配置项：

```python
# 固定白名单IP配置（这些IP会完全跳过所有验证，直接放行）
# 支持单个IP和CIDR格式，例如: ["192.168.1.100", "10.0.0.0/24"]
FIXED_IP_WHITELIST = []
```

### 配置示例

#### 示例 1：添加单个 IP

```python
FIXED_IP_WHITELIST = ["192.168.1.100"]
```

这将允许 IP `192.168.1.100` 直接访问所有资源。

#### 示例 2：添加 CIDR 范围

```python
FIXED_IP_WHITELIST = ["192.168.1.0/24"]
```

这将允许 `192.168.1.0` 到 `192.168.1.255` 范围内的所有 IP 直接访问。

#### 示例 3：混合配置

```python
FIXED_IP_WHITELIST = [
    "192.168.1.0/24",      # 整个 192.168.1.x 网段
    "10.0.0.1",            # 单个管理 IP
    "172.16.0.0/16",       # 内部网络
    "127.0.0.1"            # 本地回环
]
```

## 使用场景

### 场景 1：内部服务器访问

```python
FIXED_IP_WHITELIST = [
    "10.0.0.0/8",          # 内部网络
    "172.16.0.0/12",       # 私有网络
]
```

### 场景 2：管理工具

```python
FIXED_IP_WHITELIST = [
    "192.168.1.100",       # 管理员工作站
    "192.168.1.101",       # 备份管理员
]
```

### 场景 3：开发测试

```python
FIXED_IP_WHITELIST = [
    "127.0.0.1",           # 本地开发
    "::1",                 # IPv6 本地
    "192.168.1.0/24",      # 开发网络
]
```

## 验证流程

当请求到达时，系统按以下顺序进行验证：

1. **固定白名单检查**（最早执行）
   - 如果 IP 在固定白名单中 → 直接放行，跳过所有后续检查
   - 如果 IP 不在固定白名单中 → 继续正常验证流程

2. **常规验证流程**（仅在未匹配固定白名单时执行）
   - IP 白名单检查（Redis）
   - 路径保护检查
   - 会话验证
   - HMAC 签名验证

## 日志输出

当固定白名单生效时，日志会显示：

```
✅ 固定白名单验证成功: IP=192.168.1.100 匹配模式=192.168.1.0/24
🔓 固定白名单放行: IP=192.168.1.100, path=/video/test.m3u8
```

## 安全建议

1. **谨慎配置**：固定白名单会完全跳过所有安全检查，请确保只添加可信任的 IP
2. **使用 CIDR 时注意范围**：避免添加过大的 CIDR 范围（如 `0.0.0.0/0`）
3. **生产环境建议**：
   - 仅添加内部网络或管理 IP
   - 定期审查白名单配置
   - 使用最小权限原则
4. **开发环境**：可以添加 `127.0.0.1` 用于本地测试

## 性能影响

- **性能提升**：白名单中的 IP 跳过所有验证，减少约 50-80% 的验证开销
- **无副作用**：空白名单（默认配置）不会影响性能
- **检查开销**：固定白名单检查使用内存中的 CIDR 匹配，几乎无性能影响

## 测试

运行测试验证配置：

```bash
cd /home/runner/work/YuemPyScripts/YuemPyScripts/Server/FileProxy
python3 tests/test_fixed_whitelist.py
```

测试将验证：
- 空白名单行为
- 单个 IP 匹配
- CIDR 范围匹配
- 多个 IP/CIDR 混合配置
- 本地回环地址

## 故障排除

### 问题：白名单没有生效

**检查项**：
1. 确认配置格式正确（Python 列表语法）
2. 检查 IP 地址格式是否正确
3. 查看日志是否有错误信息
4. 确认已重启服务器以加载新配置

### 问题：CIDR 范围不匹配

**检查项**：
1. 验证 CIDR 表示法是否正确（如 `192.168.1.0/24`）
2. 使用在线 CIDR 计算器验证范围
3. 检查是否使用了正确的子网掩码

## 与其他功能的关系

- **DISABLE_IP_WHITELIST**：测试模式配置，跳过动态 IP 白名单检查，但不同于固定白名单
- **静态文件白名单**：独立的白名单机制，用于静态文件访问控制
- **动态 IP 白名单**：通过 API 添加的临时白名单，存储在 Redis 中

固定白名单优先级最高，会在所有其他验证之前执行。

## 示例配置文件

完整的 `config.py` 配置示例：

```python
class Config:
    # ... 其他配置 ...
    
    # 固定白名单IP配置（这些IP会完全跳过所有验证，直接放行）
    # 支持单个IP和CIDR格式，例如: ["192.168.1.100", "10.0.0.0/24"]
    FIXED_IP_WHITELIST = [
        "192.168.1.0/24",      # 办公室网络
        "10.0.0.1",            # 管理服务器
    ]
    
    # ... 其他配置 ...
```

## 更新日志

- **v1.0**（2024-11）：初始版本，支持 IP 和 CIDR 格式的固定白名单
