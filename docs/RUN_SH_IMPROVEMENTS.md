# run.sh æ”¹è¿›è¯´æ˜

## æ¦‚è¿°

`run.sh` è„šæœ¬å·²å®Œå…¨é‡å†™ï¼Œé’ˆå¯¹ Debian/Ubuntu ç³»ç»Ÿä¼˜åŒ–ï¼Œæä¾›å…¨è‡ªåŠ¨åŒ–çš„éƒ¨ç½²å’Œå¯åŠ¨æµç¨‹ã€‚

## ä¸»è¦æ”¹è¿›

### 1. âœ… ç³»ç»Ÿä¾èµ–æ£€æŸ¥å’Œå®‰è£…

**æ–°å¢åŠŸèƒ½**ï¼š
- è‡ªåŠ¨æ£€æµ‹æ“ä½œç³»ç»Ÿï¼ˆUbuntu/Debianï¼‰
- æ£€æŸ¥å¹¶å®‰è£…æ‰€æœ‰å¿…éœ€çš„ç³»ç»ŸåŒ…
- åŒ…æ‹¬ç¼–è¯‘å·¥å…·é“¾ï¼ˆç”¨äº uvloopï¼‰

**å®‰è£…çš„ç³»ç»ŸåŒ…**ï¼š
```
python3           # Python 3.x
python3-pip       # pip åŒ…ç®¡ç†å™¨
python3-venv      # è™šæ‹Ÿç¯å¢ƒæ”¯æŒ
python3-dev       # Python å¼€å‘å¤´æ–‡ä»¶ï¼ˆç¼–è¯‘ uvloop éœ€è¦ï¼‰
build-essential   # ç¼–è¯‘å·¥å…·é“¾ï¼ˆgccã€make ç­‰ï¼‰
redis-server      # Redis æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰
lsof              # ç«¯å£æ£€æŸ¥å·¥å…·
curl              # HTTP å®¢æˆ·ç«¯
```

### 2. âœ… Python ç‰ˆæœ¬éªŒè¯

**æ–°å¢åŠŸèƒ½**ï¼š
- æ£€æŸ¥ Python ç‰ˆæœ¬æ˜¯å¦ >= 3.8
- å¦‚æœç‰ˆæœ¬ä¸ç¬¦åˆè¦æ±‚ï¼Œç«‹å³é€€å‡ºå¹¶æç¤º

### 3. âœ… ä¾èµ–å®‰è£…éªŒè¯

**æ–°å¢åŠŸèƒ½**ï¼š
- å®‰è£…åéªŒè¯å…³é”®åŒ…æ˜¯å¦æ­£ç¡®å®‰è£…
- æ˜¾ç¤ºæ¯ä¸ªåŒ…çš„ç‰ˆæœ¬å·
- éªŒè¯çš„å…³é”®åŒ…ï¼š
  - fastapi
  - uvicorn
  - httpx
  - redis
  - uvloop

### 4. âœ… ç«¯å£å ç”¨æ™ºèƒ½å¤„ç†

**æ”¹è¿›**ï¼š
- æ£€æµ‹ç«¯å£å ç”¨æƒ…å†µ
- æ˜¾ç¤ºå ç”¨ç«¯å£çš„è¿›ç¨‹ä¿¡æ¯
- è¯¢é—®ç”¨æˆ·æ˜¯å¦æ€æ­»è¿›ç¨‹ï¼ˆè€Œä¸æ˜¯å¼ºåˆ¶æ€æ­»ï¼‰
- æ›´å®‰å…¨ã€æ›´å‹å¥½

### 5. âœ… FastAPI é…ç½®æ›´æ–°

**æ”¹è¿›**ï¼š
- ä½¿ç”¨æ­£ç¡®çš„ FastAPI requirements.txt
- æ”¯æŒä¸¤ç§å¯åŠ¨æ¨¡å¼ï¼š
  - **ç”Ÿäº§æ¨¡å¼**ï¼šä½¿ç”¨ gunicorn + uvicorn workers
  - **å¼€å‘æ¨¡å¼**ï¼šä½¿ç”¨ uvicorn å•è¿›ç¨‹ + çƒ­é‡è½½

### 6. âœ… è‡ªåŠ¨æ£€æµ‹ CPU æ ¸æ•°

**æ”¹è¿›**ï¼š
- ä½¿ç”¨ `nproc` è‡ªåŠ¨æ£€æµ‹ CPU æ ¸æ•°
- Worker æ•°é‡ = CPU æ ¸æ•°
- å¯åœ¨è„šæœ¬é¡¶éƒ¨æ‰‹åŠ¨è°ƒæ•´

### 7. âœ… å½©è‰²è¾“å‡ºå’Œè¿›åº¦æç¤º

**æ”¹è¿›**ï¼š
- ä½¿ç”¨é¢œè‰²åŒºåˆ†ä¸åŒç±»å‹çš„æ¶ˆæ¯ï¼ˆé”™è¯¯ã€è­¦å‘Šã€æˆåŠŸï¼‰
- æ¸…æ™°çš„æ­¥éª¤ç¼–å·ï¼ˆ[1/7]ã€[2/7] ç­‰ï¼‰
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

### 8. âœ… é”™è¯¯å¤„ç†

**æ”¹è¿›**ï¼š
- ä½¿ç”¨ `set -e` é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
- æ£€æŸ¥ sudo æƒé™
- æ›´è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```bash
chmod +x run.sh
./run.sh
```

### è‡ªå®šä¹‰é…ç½®

ç¼–è¾‘è„šæœ¬é¡¶éƒ¨çš„é…ç½®å˜é‡ï¼š

```bash
PORT=7889              # ä¿®æ”¹æœåŠ¡ç«¯å£
WORKER_COUNT=$(nproc)  # ä¿®æ”¹ worker æ•°é‡
```

### é¦–æ¬¡è¿è¡Œ

é¦–æ¬¡è¿è¡Œæ—¶ï¼Œè„šæœ¬ä¼šï¼š
1. å®‰è£…æ‰€æœ‰ç³»ç»Ÿä¾èµ–ï¼ˆéœ€è¦ sudo æƒé™ï¼‰
2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
3. å®‰è£… Python åŒ…
4. å¯åŠ¨æœåŠ¡å™¨

### åç»­è¿è¡Œ

åç»­è¿è¡Œæ—¶ï¼Œè„šæœ¬ä¼šï¼š
1. è·³è¿‡å·²å®‰è£…çš„ç³»ç»Ÿä¾èµ–
2. ä½¿ç”¨ç°æœ‰è™šæ‹Ÿç¯å¢ƒ
3. æ›´æ–° Python åŒ…ï¼ˆå¦‚æœ requirements.txt å˜åŒ–ï¼‰
4. å¯åŠ¨æœåŠ¡å™¨

## è¾“å‡ºç¤ºä¾‹

```
========================================
  FastAPI æ–‡ä»¶ä»£ç†æœåŠ¡å™¨å¯åŠ¨è„šæœ¬
========================================
ğŸ“ é¡¹ç›®ç›®å½•ï¼š/opt/fileproxy/Server/FileProxy
ğŸ”¢ CPU æ ¸æ•°ï¼š4
ğŸ”Œ æœåŠ¡ç«¯å£ï¼š7889

[1/7] æ£€æŸ¥æ“ä½œç³»ç»Ÿ...
âœ“ æ£€æµ‹åˆ°ç³»ç»Ÿï¼šubuntu 22.04

[2/7] æ£€æŸ¥ç³»ç»Ÿä¾èµ–...
âœ“ æ‰€æœ‰ç³»ç»Ÿä¾èµ–å·²å®‰è£…

[3/7] æ£€æŸ¥ Python ç‰ˆæœ¬...
âœ“ Python ç‰ˆæœ¬ï¼š3.10.12

[4/7] åˆ›å»º/æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ...
âœ“ è™šæ‹Ÿç¯å¢ƒå·²å­˜åœ¨

[5/7] å®‰è£… Python ä¾èµ–...
ğŸ“¦ å‡çº§ pip...
ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–...
âœ“ Python ä¾èµ–å®‰è£…å®Œæˆ

éªŒè¯å…³é”®åŒ…å®‰è£…...
  âœ“ fastapi (0.104.1)
  âœ“ uvicorn (0.24.0)
  âœ“ httpx (0.25.1)
  âœ“ redis (4.6.0)
  âœ“ uvloop (0.19.0)

[6/7] æ£€æŸ¥ç«¯å£ 7889...
âœ“ ç«¯å£ 7889 å¯ç”¨

[7/7] å¯åŠ¨ FastAPI æœåŠ¡å™¨...

ğŸš€ ä½¿ç”¨ gunicorn å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨...
é…ç½®ï¼š
  â€¢ Workers: 4
  â€¢ ç«¯å£: 7889
  â€¢ Worker ç±»: uvicorn.workers.UvicornWorker
  â€¢ æ—¥å¿—: /var/log/fileproxy/

[2025-10-31 07:00:00] [INFO] Starting gunicorn 21.2.0
[2025-10-31 07:00:00] [INFO] Listening at: http://0.0.0.0:7889
[2025-10-31 07:00:00] [INFO] Using worker: uvicorn.workers.UvicornWorker
[2025-10-31 07:00:00] [INFO] Booting worker with pid: 12345
```

## ä¸æ—§ç‰ˆæœ¬å¯¹æ¯”

| ç‰¹æ€§ | æ—§ç‰ˆ run.sh | æ–°ç‰ˆ run.sh |
|-----|------------|------------|
| ç³»ç»Ÿä¾èµ–æ£€æŸ¥ | âŒ | âœ… è‡ªåŠ¨å®‰è£… |
| Python ç‰ˆæœ¬æ£€æŸ¥ | âŒ | âœ… æ£€æŸ¥ 3.8+ |
| ä¾èµ–éªŒè¯ | âŒ | âœ… å®‰è£…åéªŒè¯ |
| ç«¯å£å¤„ç† | å¼ºåˆ¶æ€æ­» | è¯¢é—®ç”¨æˆ· |
| æ¡†æ¶æ”¯æŒ | aiohttp | FastAPI |
| Worker ç±»å‹ | GunicornWebWorker | UvicornWorker |
| å½©è‰²è¾“å‡º | âŒ | âœ… |
| é”™è¯¯å¤„ç† | åŸºç¡€ | å®Œå–„ |
| CPU è‡ªåŠ¨æ£€æµ‹ | âŒ | âœ… |
| ä¸¤ç§å¯åŠ¨æ¨¡å¼ | âŒ | âœ… |

## é…ç½®æ–‡ä»¶

### gunicorn_fastapi.conf.py

å·²æ›´æ–°é…ç½®ï¼š
- ç«¯å£ï¼š7889ï¼ˆç»Ÿä¸€ï¼‰
- æ—¥å¿—ï¼šæ”¯æŒ /var/log/fileproxyï¼ˆä¼˜å…ˆï¼‰æˆ–æœ¬åœ° logs/
- PIDï¼šæ”¯æŒ /var/run/fileproxyï¼ˆä¼˜å…ˆï¼‰æˆ–æœ¬åœ° logs/
- Worker ç±»ï¼šuvicorn.workers.UvicornWorker
- äº‹ä»¶å¾ªç¯ï¼šuvloop
- HTTP è§£æå™¨ï¼šhttptools

### requirements.txt

FastAPI ä¾èµ–ï¼š
```
fastapi>=0.104.0
uvicorn[standard]>=0.24.0
httpx[http2]>=0.25.0
redis>=4.5.0
uvloop>=0.19.0
python-multipart>=0.0.6
gunicorn>=21.2.0
```

## Systemd æœåŠ¡

æ–°å¢ `fileproxy.service`ï¼Œç”¨äºç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼š

```bash
# å®‰è£…æœåŠ¡
sudo cp fileproxy.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl start fileproxy
sudo systemctl enable fileproxy

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status fileproxy
```

è¯¦è§ï¼š`docs/DEPLOYMENT_GUIDE.md`

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šç¼ºå°‘ç³»ç»ŸåŒ…

**ç—‡çŠ¶**ï¼š
```
âœ— ç¼ºå°‘ä»¥ä¸‹ç³»ç»ŸåŒ…ï¼špython3-dev build-essential
```

**è§£å†³**ï¼š
è„šæœ¬ä¼šè‡ªåŠ¨å®‰è£…ï¼Œä½†éœ€è¦ sudo æƒé™ã€‚å¦‚æœæ²¡æœ‰ sudo æƒé™ï¼Œæ‰‹åŠ¨è¿è¡Œï¼š
```bash
sudo apt-get update
sudo apt-get install -y python3-dev build-essential
```

### é—®é¢˜ï¼šPython ç‰ˆæœ¬è¿‡ä½

**ç—‡çŠ¶**ï¼š
```
âœ— éœ€è¦ Python 3.8 æˆ–æ›´é«˜ç‰ˆæœ¬
```

**è§£å†³**ï¼š
å‡çº§ Python æˆ–ä½¿ç”¨ pyenvï¼š
```bash
# ä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨
sudo apt-get install python3.10

# æˆ–ä½¿ç”¨ pyenv
curl https://pyenv.run | bash
pyenv install 3.10.12
pyenv global 3.10.12
```

### é—®é¢˜ï¼šç«¯å£è¢«å ç”¨

**ç—‡çŠ¶**ï¼š
```
âš ï¸  ç«¯å£ 7889 è¢«ä»¥ä¸‹è¿›ç¨‹å ç”¨ï¼š
```

**è§£å†³**ï¼š
è„šæœ¬ä¼šè¯¢é—®æ˜¯å¦æ€æ­»è¿›ç¨‹ã€‚é€‰æ‹© `y` ç»§ç»­ï¼Œæˆ–æ‰‹åŠ¨å¤„ç†ï¼š
```bash
# æŸ¥çœ‹è¿›ç¨‹
lsof -i :7889

# æ€æ­»è¿›ç¨‹
kill -9 <PID>
```

### é—®é¢˜ï¼šuvloop ç¼–è¯‘å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
error: command 'gcc' failed
```

**è§£å†³**ï¼š
ç¡®ä¿å®‰è£…äº†ç¼–è¯‘å·¥å…·ï¼š
```bash
sudo apt-get install -y build-essential python3-dev
pip install --upgrade --force-reinstall uvloop
```

## æœ€ä½³å®è·µ

### å¼€å‘ç¯å¢ƒ

```bash
# ä½¿ç”¨å¼€å‘æ¨¡å¼ï¼ˆçƒ­é‡è½½ï¼‰
# åˆ é™¤æˆ–é‡å‘½å gunicorn_fastapi.conf.py
mv gunicorn_fastapi.conf.py gunicorn_fastapi.conf.py.bak
./run.sh
```

### ç”Ÿäº§ç¯å¢ƒ

```bash
# ä½¿ç”¨ systemd æœåŠ¡ï¼ˆæ¨èï¼‰
sudo systemctl start fileproxy

# æˆ–ä½¿ç”¨ run.shï¼ˆåå°è¿è¡Œï¼‰
nohup ./run.sh > /dev/null 2>&1 &
```

## ç›¸å…³æ–‡æ¡£

- **éƒ¨ç½²æŒ‡å—**ï¼š`docs/DEPLOYMENT_GUIDE.md`
- **å¿«é€Ÿå¼€å§‹**ï¼š`docs/QUICK_START.md`
- **æ¶æ„æ–‡æ¡£**ï¼š`docs/ARCHITECTURE.md`
- **FastAPI æŒ‡å—**ï¼š`docs/README_FASTAPI.md`

## æ€»ç»“

æ–°ç‰ˆ `run.sh` æä¾›ï¼š
- âœ… å®Œå…¨è‡ªåŠ¨åŒ–çš„éƒ¨ç½²æµç¨‹
- âœ… å…¨é¢çš„ä¾èµ–æ£€æŸ¥å’Œå®‰è£…
- âœ… æ™ºèƒ½çš„é”™è¯¯å¤„ç†
- âœ… æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- âœ… ç”Ÿäº§ç¯å¢ƒå°±ç»ª

é€‚ç”¨äº Debian/Ubuntu ç³»ç»Ÿï¼Œå¼€ç®±å³ç”¨ï¼
